<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>React App Framework - 11. Webpack 5 Module Federation - Mosby</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#000000"><meta name="application-name" content="Mosby Zhou Blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="msapplication-TileColor" content="#000000"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Mosby Zhou Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="256x256" href="/img/favicon.png"><meta name="description" content="Webpack 5 Module Federation 实际运用, 优化开发部署效率"><meta property="og:type" content="blog"><meta property="og:title" content="Mosby Zhou Blog"><meta property="og:url" content="https://mosby-zhou.github.io/2021/10-13-react-app-webpack-5-module-federation/"><meta property="og:site_name" content="Mosby"><meta property="og:description" content="Webpack 5 Module Federation 实际运用, 优化开发部署效率"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mosby-zhou.github.io/img/og_image.png"><meta property="article:published_time" content="2021-10-13T06:32:41.000Z"><meta property="article:author" content="Mosby"><meta property="article:tag" content="react"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mosby-zhou.github.io/2021/10-13-react-app-webpack-5-module-federation/"},"headline":"React App Framework - 11. Webpack 5 Module Federation","image":["https://mosby-zhou.github.io/img/og_image.png"],"datePublished":"2021-10-13T06:32:41.000Z","author":{"@type":"Person","name":"Mosby"},"publisher":{"@type":"Organization","name":"Mosby","logo":{"@type":"ImageObject","url":"https://mosby-zhou.github.io/img/logo.png"}},"description":"Webpack 5 Module Federation 实际运用, 优化开发部署效率"}</script><link rel="canonical" href="https://mosby-zhou.github.io/2021/10-13-react-app-webpack-5-module-federation/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Mosby" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/mosby-zhou"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-10-13T06:32:41.000Z" title="10/13/2021, 6:32:41 AM">2021-10-13</time>发表</span><span class="level-item"><a class="link-muted" href="/categories/Web/">Web</a><span> / </span><a class="link-muted" href="/categories/Web/React/">React</a></span><span class="level-item">19 分钟读完 (大约2818个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">React App Framework - 11. Webpack 5 Module Federation</h1><div class="content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>久违的<code>React-App-Framework</code>终于有了新内容了, 从一年前就开始关注的<code>Create-React-App</code>对于<code>Webpack5</code>的支持, 在上个月终于有了可以稳定使用的版本, 可以通过<code>@next</code>版本来使用<code>webpack5</code>开发, 也可以使用期待很久的文件缓存加速和<code>Module Federation</code>了, 而且对于分子应用来说, <code>Module Federation</code>提供的各自打包发布能力格外重要. 经过一段时间的试用和踩坑, 终于完成了子应用分离打包部署, 这里记录下部分重点内容.</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="config-overrides"><a href="#config-overrides" class="headerlink" title="config-overrides"></a><code>config-overrides</code></h2><p>之前在<code>webpack4</code>开发时, 是通过<code>npm run eject</code>后实现修改<code>webpack.config.js</code>的, 这样的好处是自由, 但是问题是不方便维护. 所以这次决定切换成使用<code>react-app-rewired</code>来实现修改<code>webpack.config</code></p>
<h2 id="sass-less"><a href="#sass-less" class="headerlink" title="sass/less"></a><code>sass/less</code></h2><p><code>sass/less</code>和<code>typescript</code>主题变量注入的使用方法基本没有变化, 在<code>config</code>中找到对应的<code>loaders</code>加入相关修改即可, <code>web-worker</code>的支持也是同理, 不过其中有部分动态生成的配置需要从<code>react-scripts/config/webpack.config.js</code>中复制出来使用, 因为它没有暴露公开接口</p>
<h3 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h3><p><code>react-app-rewired</code>的<code>build</code>和<code>start</code>都是可以使用<code>node debug</code>的, 可以在运行时断点查看相应配置是否正确</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;start debug building&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/node_modules/react-app-rewired/scripts/start.js&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;args&quot;</span>: [<span class="string">&quot;&quot;</span>],</span><br><span class="line">      <span class="attr">&quot;outFiles&quot;</span>: [<span class="string">&quot;$&#123;workspaceFolder&#125;/config/*.js&quot;</span>],</span><br><span class="line">      <span class="attr">&quot;env&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调整完成所有配置启动之后, 发现了第一个问题: 切换主题变量之后不会触发重新编译, 导致页面主题不变</p>
<h2 id="cache与theme"><a href="#cache与theme" class="headerlink" title="cache与theme"></a><code>cache</code>与<code>theme</code></h2><p>最开始怀疑是之前开发的<code>babelLoader.options.customize</code>缓存注入组件由于<code>webpack</code>配置变更导致没有生效, 但是实际测试后发现是有效的. 同时删除缓存文件之后主题也是可以改变的, 再联想到<code>webpack5</code>对于缓存有了比较大的优化, 所以基本能确定问题出现在<code>webpack5</code>的最新的缓存机制上了</p>
<p><code>webpack5</code>支持了基于文件系统的持久化缓存, <a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/cache/#cache">官方文档</a>指明它会在依赖项和配置内容不变的时候, 直接读取缓存内容, 不会进行任何编译. 所以可以很明确的知道问题出现在这里了, 同时官方也提供了解决方案: <code>version</code>参数, 设置<code>version</code>参数后, <code>webpack</code>就会针对不同的版本启用不同的缓存路径, 对于我们指定主题来说, 非常方便, 而且也不会造成切换主题时缓存失效了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.cache.version = <span class="string">`<span class="subst">$&#123;config.cache.version&#125;</span>-<span class="subst">$&#123;buildConfig.options.appTheme&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Module-Federation"><a href="#Module-Federation" class="headerlink" title="Module Federation"></a><code>Module Federation</code></h2><p>修复缓存问题后, <code>webpack5</code>就可以正式替换<code>webpack4</code>版本了(虽然还是使用的<code>&quot;react-scripts&quot;: &quot;^5.0.0-next.47&quot;</code>版本, 但是实测页面没有任何问题). 下一步就是使用最吸引人的<code>Module Federation</code>来实现子应用的模块化开发了, <a target="_blank" rel="noopener" href="https://webpack.js.org/concepts/module-federation/">官方文档</a>介绍了<code>Module Federation</code>的基本原理, 能实现的效果是远程加载一个<code>js</code>应用, 可以理解为动态<code>import</code>的外部链接版本, 同时还支持基础库共享, 不会造成多份<code>react/antd</code>库的问题</p>
<h3 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h3><p>由于原本已经将子应用隔离划分得比较好, 支持<code>Module Federation</code>的成本其实很低, 只需要配置相应的子应用打包模块配置, 并实现动态导入即可</p>
<div class="mermaid">sequenceDiagram
  participant U as User
  participant F as Base Framework
  participant M as App Module
  alt 用户访问
    U ->> F: 1. 加载基础框架
      F ->> M: 2. 加载子应用模块代码
      M -->> U: 3 返回子应用
  end</div>

<h3 id="webpack-config"><a href="#webpack-config" class="headerlink" title="webpack.config"></a><code>webpack.config</code></h3><p>按照官方文档指导, 配置基础框架<code>shared-module</code>, 再将每个子应用抽离一个<code>ModuleFederationPlugin</code>, 并配置文件名和<code>exposes</code>即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">config.plugins = [</span><br><span class="line">  <span class="keyword">new</span> ModuleFederationPlugin(&#123;</span><br><span class="line">    <span class="attr">shared</span>: <span class="built_in">Object</span>.assign(</span><br><span class="line">      _.mapValues(pkg.dependencies, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">requiredVersion</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;)),</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&#x27;./src/other-file&#x27;</span>: &#123;</span><br><span class="line">          <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">requiredVersion</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">    <span class="attr">remotes</span>: &#123;</span><br><span class="line">      <span class="comment">// xxx</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;app_base&#x27;</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  ..._.map(</span><br><span class="line">    buildConfig.includesAppConfig,</span><br><span class="line">    <span class="function">(<span class="params">config, app</span>) =&gt;</span></span><br><span class="line">      <span class="keyword">new</span> ModuleFederationPlugin(&#123;</span><br><span class="line">        <span class="attr">shared</span>: <span class="built_in">Object</span>.assign(</span><br><span class="line">          _.mapValues(pkg.dependencies, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">            <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">requiredVersion</span>: <span class="literal">false</span>,</span><br><span class="line">          &#125;)),</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&#x27;./src/other-file&#x27;</span>: &#123;</span><br><span class="line">              <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">requiredVersion</span>: <span class="literal">false</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">`app_<span class="subst">$&#123;app&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">`remote-app-<span class="subst">$&#123;app&#125;</span>.js`</span>,</span><br><span class="line">        <span class="attr">exposes</span>: &#123;</span><br><span class="line">          [<span class="string">`./index`</span>]: <span class="string">`./src/containers/<span class="subst">$&#123;app&#125;</span>/index.tsx`</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">  ),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>配置完成后, <code>npm start</code>就能直接输出对应<code>app</code>的<code>remote.js</code>文件了, 在代码中使用也非常简单: <code>const App = React.lazy(() =&gt; import(&quot;app_xxx/index&quot;));</code>, 同时可以在<code>react-app-env.d.ts</code>中添加相关模块的定义, 这样就可以避免<code>ts</code>模块编译报错</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="built_in">module</span> <span class="string">&#x27;app_*/index&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> Component: React.FunctionComponent&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> Component;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面动态加载组件需要使用</span></span><br><span class="line"><span class="keyword">declare</span> <span class="built_in">global</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> __webpack_init_sharing__: <span class="function">(<span class="params"><span class="keyword">type</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  <span class="keyword">const</span> __webpack_share_scopes__: &#123; <span class="attr">default</span>: <span class="function">(<span class="params"><span class="keyword">type</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态加载"><a href="#动态加载" class="headerlink" title="动态加载"></a>动态加载</h3><p>这样配置完后, 通过<code>network</code>就可以看到页面会自动加载<code>remote_app.js</code>了, 但是这里存在一个问题, 查看编译后生成的<code>index.html</code>可以发现, <code>remote_app.js</code>是通过<code>&lt;script src=&quot;xxxxx.js&quot;&gt;</code>加载的, 如果子系统太多, 一次性加载的脚本太多也会导致首屏时间变长, 所以需要解决这个问题</p>
<p>官方文档和<code>demo</code>也提供了解决方案: 使用动态注入<code>script</code>实现即可, 这里直接参考官方<code>demo</code>实现<code>useDynamicScriptComponent</code>, 同时额外加上全局缓存, 可以避免在<code>react-router</code>变化的时候导致重新加载<code>React.lazy</code>组件, 导致页面状态丢失</p>
<article class="message is-info">
  <div class="message-body">
    开发完动态加载后, 需要将<code>ModuleFederationPlugin</code>中的<code>remotes</code>参数去掉, 就不会在<code>index.html</code>中注入加载脚本了
  </div>
</article>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> debug <span class="keyword">from</span> <span class="string">&#x27;../utils/debug&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cache: Record&lt;<span class="built_in">string</span>, React.LazyExoticComponent&lt;React.ComponentType&lt;<span class="built_in">any</span>&gt;&gt;&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> loadComponent = <span class="function">(<span class="params">scope: <span class="built_in">string</span>, <span class="built_in">module</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!cache[scope]) &#123;</span><br><span class="line">    cache[scope] = React.lazy(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">// Initializes the share scope. This fills it with known provided modules from this build and all remotes</span></span><br><span class="line">      <span class="keyword">await</span> __webpack_init_sharing__(<span class="string">&#x27;default&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> container = (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>)[scope]; <span class="comment">// or get the container somewhere else</span></span><br><span class="line">      <span class="comment">// Initialize the container, it may provide shared modules</span></span><br><span class="line">      <span class="keyword">await</span> container.init(__webpack_share_scopes__.default);</span><br><span class="line">      <span class="keyword">const</span> factory = <span class="keyword">await</span> (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>)[scope].get(<span class="built_in">module</span>);</span><br><span class="line">      <span class="keyword">const</span> Module = factory();</span><br><span class="line">      <span class="keyword">return</span> Module;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache[scope];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useDynamicScriptComponent = (&#123;</span><br><span class="line">  url,</span><br><span class="line">  scope,</span><br><span class="line">  <span class="built_in">module</span>,</span><br><span class="line">&#125;: &#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="built_in">string</span>;</span><br><span class="line">  scope: <span class="built_in">string</span>;</span><br><span class="line">  <span class="built_in">module</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;): React.LazyExoticComponent&lt;React.ComponentType&lt;<span class="built_in">any</span>&gt;&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [ready, setReady] = useState(<span class="function">() =&gt;</span> !!cache[scope]);</span><br><span class="line">  <span class="keyword">const</span> [failed, setFailed] = useState(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!url) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache[scope]) &#123;</span><br><span class="line">      setReady(<span class="literal">true</span>);</span><br><span class="line">      setFailed(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    element.src = url;</span><br><span class="line">    element.type = <span class="string">&#x27;text/javascript&#x27;</span>;</span><br><span class="line">    element.async = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    setReady(<span class="literal">false</span>);</span><br><span class="line">    setFailed(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    element.onload = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      debug.log(<span class="string">`Dynamic Script Loaded: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">      setReady(<span class="literal">true</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    element.onerror = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      debug.error(<span class="string">`Dynamic Script Error: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">      setReady(<span class="literal">false</span>);</span><br><span class="line">      setFailed(<span class="literal">true</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">document</span>.head.appendChild(element);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      debug.log(<span class="string">`Dynamic Script Removed: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">      <span class="built_in">document</span>.head.removeChild(element);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [url, scope]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!ready || failed) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> loadComponent(scope, <span class="built_in">module</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useDynamicScriptComponent;</span><br></pre></td></tr></table></figure>

<h3 id="模块配置管理"><a href="#模块配置管理" class="headerlink" title="模块配置管理"></a>模块配置管理</h3><p>实现完动态模块加载后, 就可以将模块路径实现动态注入了, 最开始考虑开发一个独立的服务端接口用于管理, 但后来发现可以直接使用<code>k8s</code>提供的<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMaps</a>来实现动态管理模块</p>
<p>首先在<code>public/config/module.js</code>下定义好模块配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.__appModule = &#123;</span><br><span class="line">  <span class="attr">app_xxx</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: host + <span class="string">&#x27;app-modules/app-xxx/remote-app-xxx.js&#x27;</span>,</span><br><span class="line">    <span class="attr">scope</span>: <span class="string">&#x27;app_xxx&#x27;</span>,</span><br><span class="line">    <span class="attr">module</span>: <span class="string">&#x27;./index&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后在<code>ConfigMaps</code>中添加对<code>public/config</code>目录的覆盖, 将配置挂载到<code>module.js</code>中, 在需要使用的时候直接使用<code>window.__appModule</code>读取全局变量, 就可以实现热更新模块功能了</p>
<p>同时修改<code>nginx</code>配置, 将模块管理部分独立一个容器, 可以实现所有测试环境共用同一个模块管理后端, 也能减少模块管理的复杂度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location ^~ /app-modules/ &#123;</span><br><span class="line">        proxy_buffering off;</span><br><span class="line">        proxy_pass http://app-module-server;</span><br><span class="line">        proxy_redirect default;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.html$ &#123;</span><br><span class="line">        add_header Cache-Control &quot;private, no-cache, no-store, must-revalidate&quot;;</span><br><span class="line">        try_files $uri /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ ^/config/module\.js$ &#123;</span><br><span class="line">        add_header Cache-Control &quot;no-cache&quot;;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>app-modules-nginx-server</code>内就使用已有的服务端代码发布流程, 将打包后的代码发布到此容器内即可, 不同应用不同分支都有独立的文件夹, 可以通过外层<code>configmaps</code>随时切换需要的分支</p>
<h3 id="子应用代理动态配置"><a href="#子应用代理动态配置" class="headerlink" title="子应用代理动态配置"></a>子应用代理动态配置</h3><p>完成子应用的动态加载后, 如果需要切换子应用的<code>nginx-proxy</code>还是需要重启整个容器, 同样考虑动态配置实现, 最初考虑过使用<a target="_blank" rel="noopener" href="https://nginxproxymanager.com/">nginxproxymanager</a>, 但是维护起来比较复杂, 就决定直接使用<code>ConfigMaps</code>来实现了, 配置如下, 这里的<code>conf.d/app-proxy/</code>也是通过<code>ConfigMaps</code>来注入的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    include conf.d/app-proxy/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后开发一个简单的文件监听重启<code>nginx</code>的服务, 可以充分利用<code>nginx</code>的配置检测和热更新功能, 保证了线上环境的正常运行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> child_process = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line">fs.watch(path.resolve(<span class="string">&#x27;/etc/nginx/conf.d/app-proxy&#x27;</span>), <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">event, filename</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`event is: <span class="subst">$&#123;event&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`filename provided: <span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`filename not provided`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  child_process.spawn(<span class="string">&#x27;/usr/sbin/nginx&#x27;</span>, [<span class="string">&#x27;-t&#x27;</span>], &#123; <span class="attr">stdio</span>: <span class="string">&#x27;inherit&#x27;</span> &#125;);</span><br><span class="line">  child_process.spawn(<span class="string">&#x27;/usr/sbin/nginx&#x27;</span>, [<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;reload&#x27;</span>], &#123; <span class="attr">stdio</span>: <span class="string">&#x27;inherit&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`nginx conf watching`</span>);</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>完成以上内容后, 就成功的将<code>Module Federation</code>使用到项目中了. 对比之前的架构, 能实现基础框架动态更新子应用代理/代码模块, 子模块发布代码统一管理, 容器基本不用重启, 基本告别运维压力了. 而且<code>webpack5</code>带来的文件缓存也极大的提高了开发效率, 独立子应用打包速度也有了飞速提升.</p>
<h3 id="页面架构"><a href="#页面架构" class="headerlink" title="页面架构"></a>页面架构</h3><p>最终的页面架构如下</p>
<div class="mermaid">sequenceDiagram
  participant Br as Browser
  participant BN as Base Nginx
  participant BA as Base App Code
  participant SS as Subapp Module Server
  participant SN as Subapp Module Nginx
  participant SC as Subapp Module Code
  alt 页面加载
    Br ->> BN: 1. 访问系统
    BN ->> BA: 2. 读取基础框架代码
    BA -->> Br: 3.1 返回基础框架代码
    BA -->> Br: 3.2 返回module.js
    Br ->> BN: 4. 访问子模块代码
    BN ->> SN: 5. 访问子模块代码
    SN ->> SC: 6. 读取本地子模块代码
    SC -->> Br: 7. 返回子模块代码
    Br ->> BN: 8. 发起子模块api请求
    BN ->> SS: 9. 转发到子模块server
    SS -->> Br: 10. 返回请求结果
    BN -->> BN: 监听configmaps触发nginx配置更新重启
    BN -->> BN: 更新configmaps的module.js文件
    SN -->> SN: 更新子模块代码
  end</div>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><code>webpack5</code>对比起<code>webpack4</code>确实基本能做到无痛升级, 但<code>Module Federation</code>里是对代码质量有些要求的, 这里记录一下遇到的一些问题和解决方案</p>
<h3 id="codemirror-require"><a href="#codemirror-require" class="headerlink" title="codemirror/require"></a><code>codemirror/require</code></h3><p>代码中有个地方使用了<code>codemirror</code>, 然后在测试时发现, 如果切换子应用(不同的<code>app_module</code>), 后加载的子应用的<code>codemirror</code>没有样式. 研究后发现是因为<code>codemirror</code>代码中使用的<code>require</code>是相对路径, 在共享模块的时候不会生效, 需要修改为共享模块引用, 于是通过<code>webpack-loader</code>实现打包时动态替换解决了这个问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">config.module.rules.unshift(&#123;</span><br><span class="line">  <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">  include: path.resolve(<span class="string">&#x27;node_modules/codemirror&#x27;</span>),</span><br><span class="line">  <span class="attr">enforce</span>: <span class="string">&#x27;pre&#x27;</span>,</span><br><span class="line">  <span class="attr">loader</span>: <span class="string">&#x27;pattern-replace-loader&#x27;</span>,</span><br><span class="line">  <span class="attr">options</span>: &#123;</span><br><span class="line">    <span class="attr">verbose</span>: buildConfig.options.verbose,</span><br><span class="line">    <span class="attr">search</span>: <span class="regexp">/&quot;\.\.\/\.\.\/lib\/codemirror&quot;/g</span>,</span><br><span class="line">    replace: <span class="string">&#x27;&quot;codemirror&quot;&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="d3-js打包失败"><a href="#d3-js打包失败" class="headerlink" title="d3.js打包失败"></a><code>d3.js</code>打包失败</h3><p>在引用<code>d3</code>的时候, <code>npm start</code>不会有问题, 但是在<code>build</code>的时候会有如下报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Module not found: Error: Can&#x27;t resolve &#x27;/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper&#x27; in &#x27;/node_modules/d3-array/src&#x27;</span><br><span class="line">Did you mean &#x27;createForOfIteratorHelper.js&#x27;?</span><br></pre></td></tr></table></figure>

<p>在<code>webpack</code>中添加<code>resolve</code>的处理即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config.module.rules.unshift(&#123;</span><br><span class="line">  <span class="attr">test</span>: <span class="regexp">/\.m?js/</span>,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    <span class="attr">fullySpecified</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h3><p>在没有使用<code>Module Federation</code>的时候, 代码里的循环引用不会出问题, 因为<code>webpack</code>的模块加载可以解决循环引用, 但是<code>Module Federation</code>里的循环引用会导致<code>remote.js</code>出现报错, 于是只能加上<code>&quot;import/no-cycle&quot;: &quot;error&quot;</code>和<code>&quot;plugin:import/recommended&quot;, &quot;plugin:import/typescript&quot;</code>的<code>EsLint</code>插件检测循环引用, 然后调整相关问题代码</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>React App Framework - 11. Webpack 5 Module Federation</p><p><a href="https://mosby-zhou.github.io/2021/10-13-react-app-webpack-5-module-federation/">https://mosby-zhou.github.io/2021/10-13-react-app-webpack-5-module-federation/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Mosby</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-10-13</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/react/">react</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.png" alt="支付宝"></span></a><a class="button donate" href="https://www.buymeacoffee.com/mosby" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/08-19-esbuild-vs-babel/"><span class="level-item">Esbuild vs Babel</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "730faf4a0d4322ec7c3f8fc02b0067d4",
            repo: "mosby-zhou.github.io",
            owner: "mosby-zhou",
            clientID: "16bcda17da1d8096c181",
            clientSecret: "eeca61cbccf5f011dc54308ffa8dbfba816efe32",
            admin: ["mosby-zhou"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Mosby"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Mosby</p><p class="is-size-6 is-block">Full stack development</p><p class="is-size-6 is-flex justify-content-center"><a class="link-muted" target="_blank" href="https://www.amap.com/search?query=%E5%B9%BF%E5%B7%9E"><i class="fas fa-map-marker-alt mr-1"></i></a><span>Guangzhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">83</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">21</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/mosby-zhou" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#背景"><span class="level-left"><span class="level-item">1</span><span class="level-item">背景</span></span></a></li><li><a class="level is-mobile" href="#配置"><span class="level-left"><span class="level-item">2</span><span class="level-item">配置</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#config-overrides"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">config-overrides</span></span></a></li><li><a class="level is-mobile" href="#sass-less"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">sass/less</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#调试方法"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">调试方法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#cache与theme"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">cache与theme</span></span></a></li><li><a class="level is-mobile" href="#Module-Federation"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">Module Federation</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#架构设计"><span class="level-left"><span class="level-item">2.4.1</span><span class="level-item">架构设计</span></span></a></li><li><a class="level is-mobile" href="#webpack-config"><span class="level-left"><span class="level-item">2.4.2</span><span class="level-item">webpack.config</span></span></a></li><li><a class="level is-mobile" href="#动态加载"><span class="level-left"><span class="level-item">2.4.3</span><span class="level-item">动态加载</span></span></a></li><li><a class="level is-mobile" href="#模块配置管理"><span class="level-left"><span class="level-item">2.4.4</span><span class="level-item">模块配置管理</span></span></a></li><li><a class="level is-mobile" href="#子应用代理动态配置"><span class="level-left"><span class="level-item">2.4.5</span><span class="level-item">子应用代理动态配置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#小结"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">小结</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#页面架构"><span class="level-left"><span class="level-item">2.5.1</span><span class="level-item">页面架构</span></span></a></li></ul></li><li><a class="level is-mobile" href="#其他"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">其他</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#codemirror-require"><span class="level-left"><span class="level-item">2.6.1</span><span class="level-item">codemirror/require</span></span></a></li><li><a class="level is-mobile" href="#d3-js打包失败"><span class="level-left"><span class="level-item">2.6.2</span><span class="level-item">d3.js打包失败</span></span></a></li><li><a class="level is-mobile" href="#循环引用"><span class="level-left"><span class="level-item">2.6.3</span><span class="level-item">循环引用</span></span></a></li></ul></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Code/"><span class="level-start"><span class="level-item">Code</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/Code/Others/"><span class="level-start"><span class="level-item">Others</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Code/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Code/Regex/"><span class="level-start"><span class="level-item">Regex</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Code/Sql/"><span class="level-start"><span class="level-item">Sql</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Computer-Science/"><span class="level-start"><span class="level-item">Computer Science</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Server/"><span class="level-start"><span class="level-item">Server</span></span><span class="level-end"><span class="level-item tag">11</span></span></a><ul><li><a class="level is-mobile" href="/categories/Server/Docker/"><span class="level-start"><span class="level-item">Docker</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Server/Egg/"><span class="level-start"><span class="level-item">Egg</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Server/File-System/"><span class="level-start"><span class="level-item">File System</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Server/Others/"><span class="level-start"><span class="level-item">Others</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Web/"><span class="level-start"><span class="level-item">Web</span></span><span class="level-end"><span class="level-item tag">61</span></span></a><ul><li><a class="level is-mobile" href="/categories/Web/Angularjs/"><span class="level-start"><span class="level-item">Angularjs</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/ES6/"><span class="level-start"><span class="level-item">ES6</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/Extensions/"><span class="level-start"><span class="level-item">Extensions</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/JavaScript/"><span class="level-start"><span class="level-item">JavaScript</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/Next/"><span class="level-start"><span class="level-item">Next</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/React/"><span class="level-start"><span class="level-item">React</span></span><span class="level-end"><span class="level-item tag">39</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/React-Native/"><span class="level-start"><span class="level-item">React Native</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/TypeScript/"><span class="level-start"><span class="level-item">TypeScript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/egg/"><span class="tag">egg</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript/"><span class="tag">javascript</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/others/"><span class="tag">others</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/programming/"><span class="tag">programming</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/react/"><span class="tag">react</span><span class="tag">40</span></a></div><div class="control"><a class="tags has-addons" href="/tags/react-native/"><span class="tag">react-native</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sql/"><span class="tag">sql</span><span class="tag">3</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Mosby" height="28"></a><p class="is-size-7"><span>© <span id="footer_site_year">2021</span> Mosby</span><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var ThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/mermaid.min.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>